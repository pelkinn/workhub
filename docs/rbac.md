# Документация RBAC (Role-Based Access Control)

## Обзор

WorkHub использует систему ролевого доступа на уровне проектов. Каждый пользователь может быть участником нескольких проектов, и в каждом проекте у него есть определённая роль, которая определяет уровень доступа.

## Роли

Система поддерживает три роли пользователей в проектах:

### VIEWER (Наблюдатель)

- **Уровень доступа**: 1 (базовый)
- **Возможности**:
  - Просмотр проекта и его задач
  - Просмотр списка участников проекта
  - Просмотр приглашений проекта

### EDITOR (Редактор)

- **Уровень доступа**: 2 (средний)
- **Возможности**:
  - Все возможности VIEWER
  - Создание задач в проекте
  - Редактирование задач проекта
  - Удаление задач проекта
  - Создание приглашений в проект
  - Удаление приглашений проекта

### OWNER (Владелец)

- **Уровень доступа**: 3 (максимальный)
- **Возможности**:
  - Все возможности EDITOR
  - Удаление проекта

## Иерархия ролей

Роли организованы в иерархическую систему, где более высокая роль включает в себя все права более низких ролей:

```
OWNER (3)
  └─ EDITOR (2)
      └─ VIEWER (1)
```

Это означает, что пользователь с ролью OWNER автоматически имеет доступ ко всем операциям, требующим роли EDITOR или VIEWER.

## Матрица доступа

| Операция               | VIEWER | EDITOR | OWNER  |
| ---------------------- | ------ | ------ | ------ |
| **Проекты**            |
| Просмотр проекта       | ✅     | ✅     | ✅     |
| Создание проекта       | ✅\*   | ✅\*   | ✅\*   |
| Удаление проекта       | ❌     | ❌     | ✅     |
| **Задачи**             |
| Просмотр задач проекта | ✅     | ✅     | ✅     |
| Создание задачи        | ❌     | ✅     | ✅     |
| Редактирование задачи  | ❌     | ✅     | ✅     |
| Удаление задачи        | ❌     | ✅     | ✅     |
| **Участники**          |
| Просмотр участников    | ✅     | ✅     | ✅     |
| Управление участниками | ❌     | ❌     | ❌\*\* |
| **Приглашения**        |
| Просмотр приглашений   | ✅     | ✅     | ✅     |
| Создание приглашения   | ❌     | ✅     | ✅     |
| Удаление приглашения   | ❌     | ✅     | ✅     |
| Принятие приглашения   | ✅\*   | ✅\*   | ✅\*   |

\* Доступно всем аутентифицированным пользователям вне зависимости от членства в проекте  
\*\* Управление участниками происходит через систему приглашений

## Техническая реализация

### Membership Model

Связь между пользователем и проектом реализована через модель `Membership`:

```prisma
model Membership {
  id        String         @id @default(cuid())
  projectId String
  userId    String
  role      MembershipRole
  // ...
}
```

Каждая запись `Membership` определяет:

- Какой пользователь (`userId`) является участником
- Какого проекта (`projectId`)
- С какой ролью (`role`)

### MembershipsGuard

`MembershipsGuard` — это guard, который проверяет:

1. Аутентификацию пользователя (наличие JWT токена)
2. Существование проекта
3. Членство пользователя в проекте
4. Наличие требуемой роли (если указана через декоратор `@RequireRole`)

**Логика проверки роли:**

- Если указана одна роль через `@RequireRole(Role.EDITOR)`, проверяется иерархия: пользователь должен иметь роль не ниже указанной
- Если указан массив ролей `@RequireRole([Role.EDITOR, Role.OWNER])`, проверяется наличие одной из указанных ролей

**Пример использования:**

```typescript
@UseGuards(JwtAuthGuard, MembershipsGuard)
@RequireRole(MembershipRole.EDITOR)
@Post("projects/:projectId/tasks")
createTask(@Param("projectId") projectId: string) {
  // Только участники с ролью EDITOR или OWNER могут создать задачу
}
```

### RequireRole Decorator

Декоратор `@RequireRole` используется для указания минимально требуемой роли для endpoint.

**Поддерживаемые форматы:**

- `@RequireRole(MembershipRole.EDITOR)` — требуется роль EDITOR или выше
- `@RequireRole([MembershipRole.EDITOR, MembershipRole.OWNER])` — требуется одна из указанных ролей

**Важно:** Декоратор работает только в сочетании с `MembershipsGuard`.

## Использование в API

### Projects API

#### `GET /projects/:id`

- **Guard**: `JwtAuthGuard` (проверка аутентификации)
- **Проверка доступа**: Проверяется членство в проекте в сервисе
- **Доступ**: Любой участник проекта

#### `DELETE /projects/:id`

- **Guard**: `JwtAuthGuard`, `MembershipsGuard`
- **Требуемая роль**: `OWNER`
- **Доступ**: Только владельцы проекта

### Tasks API

#### `GET /projects/:projectId/tasks`

- **Guard**: `JwtAuthGuard`
- **Проверка доступа**: Проверяется членство в проекте в сервисе
- **Доступ**: Любой участник проекта

#### `POST /projects/:projectId/tasks`

- **Guard**: `JwtAuthGuard`, `MembershipsGuard`
- **Требуемая роль**: `EDITOR`
- **Доступ**: Редакторы и владельцы

#### `PUT /projects/:projectId/tasks/:taskId`

- **Guard**: `JwtAuthGuard`, `MembershipsGuard`
- **Требуемая роль**: `EDITOR`
- **Доступ**: Редакторы и владельцы

#### `DELETE /projects/:projectId/tasks/:taskId`

- **Guard**: `JwtAuthGuard`, `MembershipsGuard`
- **Требуемая роль**: `EDITOR`
- **Доступ**: Редакторы и владельцы

### Invitations API

#### `GET /projects/:projectId/invitations`

- **Guard**: `JwtAuthGuard`, `MembershipsGuard`
- **Требуемая роль**: Любой участник проекта
- **Доступ**: Все участники проекта

#### `POST /projects/:projectId/invitations`

- **Guard**: `JwtAuthGuard`, `MembershipsGuard`
- **Требуемая роль**: `EDITOR` или `OWNER`
- **Доступ**: Редакторы и владельцы
- **Ограничение**: Приглашать можно только зарегистрированных пользователей (пользователь должен существовать в системе)

#### `DELETE /projects/:projectId/invitations/:id`

- **Guard**: `JwtAuthGuard`, `MembershipsGuard`
- **Требуемая роль**: `EDITOR` или `OWNER`
- **Доступ**: Редакторы и владельцы

#### `GET /invitations/:token`

- **Guard**: Нет (публичный endpoint)
- **Доступ**: Все пользователи (без аутентификации)

#### `POST /invitations/:token/accept`

- **Guard**: `JwtAuthGuard`
- **Доступ**: Аутентифицированные пользователи, email которых совпадает с email в приглашении

### Memberships API

#### `GET /projects/:projectId/memberships`

- **Guard**: `JwtAuthGuard`, `MembershipsGuard`
- **Требуемая роль**: Любой участник проекта
- **Доступ**: Все участники проекта

## Обработка ошибок

Система возвращает следующие HTTP статусы при нарушении прав доступа:

### 403 Forbidden

Возвращается в следующих случаях:

- Пользователь не аутентифицирован
- Пользователь не является участником проекта
- Роль пользователя недостаточна для выполнения операции

**Пример сообщений:**

- `"Пользователь не аутентифицирован"`
- `"Вы не являетесь участником этого проекта"`
- `"Требуется роль EDITOR, у вас роль VIEWER"`
- `"Требуется одна из ролей: EDITOR, OWNER, у вас роль VIEWER"`

### 404 Not Found

Возвращается, если:

- Проект не найден
- Приглашение не найдено

## Приглашения и назначение ролей

### Создание приглашения

При создании приглашения указывается роль, которая будет назначена пользователю при принятии приглашения:

> **Важно:** Приглашать можно только зарегистрированных пользователей. Пользователь с указанным email должен существовать в системе.

```typescript
POST /projects/:projectId/invitations
{
  "email": "user@example.com",
  "role": "EDITOR"
}
```

### Принятие приглашения

При принятии приглашения пользователь автоматически получает указанную роль в проекте через создание записи `Membership`:

```typescript
POST /invitations/:token/accept
```

## Рекомендации по использованию

1. **Защита endpoints**: Все endpoints, связанные с проектами, должны использовать `MembershipsGuard` для проверки членства в проекте

2. **Минимальные права**: Используйте минимально необходимую роль для каждой операции (принцип наименьших привилегий)

3. **Комбинация guard'ов**: Всегда используйте `JwtAuthGuard` перед `MembershipsGuard` для гарантии аутентификации пользователя

4. **Проверка в сервисах**: Даже при наличии guard'ов, рекомендуется дополнительно проверять права доступа в сервисах для критических операций

5. **Аудит**: Все изменения прав доступа и членства в проектах должны логироваться в `AuditLog`

## Примеры использования

### Защита endpoint с одной ролью

```typescript
@UseGuards(JwtAuthGuard, MembershipsGuard)
@RequireRole(MembershipRole.EDITOR)
@Post("projects/:projectId/tasks")
createTask(@Param("projectId") projectId: string, @Body() dto: CreateTaskDto) {
  return this.tasksService.create(projectId, dto);
}
```

### Защита endpoint с несколькими ролями

```typescript
@UseGuards(JwtAuthGuard, MembershipsGuard)
@RequireRole([MembershipRole.EDITOR, MembershipRole.OWNER])
@Post("projects/:projectId/invitations")
createInvitation(@Param("projectId") projectId: string, @Body() dto: CreateInvitationDto) {
  return this.invitationsService.createInvitation(dto, projectId);
}
```

### Защита endpoint без проверки роли (только членство)

```typescript
@UseGuards(JwtAuthGuard, MembershipsGuard)
@Get("projects/:projectId/tasks")
findAll(@Param("projectId") projectId: string) {
  // Доступно всем участникам проекта независимо от роли
  return this.tasksService.findAll(projectId);
}
```

## Расширение системы

Для добавления новых ролей или изменения прав доступа:

1. Обновите enum `MembershipRole` в `schema.prisma`
2. Создайте миграцию базы данных
3. Обновите иерархию ролей в `MembershipsGuard`
4. Обновите данную документацию
5. Обновите тесты для проверки новых прав доступа

---

_Документация актуальна на момент создания системы RBAC в WorkHub. При изменениях в системе контроля доступа эта документация должна быть обновлена._
